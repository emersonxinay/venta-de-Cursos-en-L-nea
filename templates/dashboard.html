{% extends "base.html" %}
{% block title %}Dashboard - CompilandoCode{% endblock %}

{% block extra_css %}
<style>
  /* Estilos mejorados con mobile-first y degradados */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(1, 1fr);
    gap: 1rem;
    margin-bottom: 1.5rem;
  }
  
  @media (min-width: 640px) {
    .stats-grid {
      grid-template-columns: repeat(2, 1fr);
      gap: 1.25rem;
    }
  }
  
  @media (min-width: 1024px) {
    .stats-grid {
      grid-template-columns: repeat(4, 1fr);
      gap: 1.5rem;
    }
  }
  
  .course-grid {
    display: grid;
    grid-template-columns: repeat(1, 1fr);
    gap: 1.25rem;
  }
  
  @media (min-width: 640px) {
    .course-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }
  
  @media (min-width: 1024px) {
    .course-grid {
      grid-template-columns: repeat(3, 1fr);
    }
  }
  
  @media (min-width: 1280px) {
    .course-grid {
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    }
  }
  
  .progress-ring {
    transform: rotate(-90deg);
  }
  
  .progress-ring__circle {
    stroke: rgba(255, 255, 255, 0.2);
    stroke-width: 4;
    fill: transparent;
    r: 30;
    cx: 50;
    cy: 50;
  }
  
  .progress-ring__progress {
    stroke: white;
    stroke-width: 4;
    stroke-linecap: round;
    stroke-dasharray: 188.4;
    stroke-dashoffset: 188.4;
    fill: transparent;
    transition: stroke-dashoffset 0.8s ease-in-out;
  }
  
  .course-thumbnail {
    background: var(--gradient-blue-purple);
    position: relative;
    overflow: hidden;
    border-radius: var(--radius-lg) var(--radius-lg) 0 0;
  }
  
  .course-thumbnail::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="dots" width="10" height="10" patternUnits="userSpaceOnUse"><circle cx="5" cy="5" r="1" fill="rgba(255,255,255,0.1)"/></pattern></defs><rect width="100" height="100" fill="url(%23dots)"/></svg>');
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-6">
  <!-- Header Section con Degradado -->
  <div class="mb-8 animate-fadeIn">
    <div class="gradient-card mb-6" style="background: var(--gradient-primary)">
      <div class="gradient-card-body p-6">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
          <div>
            <h1 class="text-2xl md:text-3xl font-bold text-white mb-2">
              Â¡Hola, {{ current_user.nombre }}! ðŸ‘‹
            </h1>
            <p class="text-white/90">
              ContinÃºa tu viaje de aprendizaje. Tienes {{ mis_ventas|length }} cursos activos.
            </p>
          </div>
          
          <!-- Quick Actions -->
          <div class="flex flex-wrap items-center gap-3 mt-4 lg:mt-0">
            {% if current_user.rol == 'admin' %}
              <a href="{{ url_for('nuevo_curso') }}" class="btn-gradient">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                </svg>
                Crear Curso
              </a>
              <a href="{{ url_for('admin_dashboard') }}" class="btn-ghost-gradient">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                </svg>
                Panel Admin
              </a>
            {% endif %}
            
            <!-- Search -->
            <div class="input-group w-full md:w-auto mt-3 md:mt-0">
              <div class="input-icon">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
              </div>
              <input 
                id="search-input"
                type="text" 
                placeholder="Buscar cursos..." 
                class="input-gradient w-full md:w-64"
              />
            </div>
          </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Stats Cards con Degradados -->
  {% if current_user.is_authenticated %}
  <div class="stats-grid animate-fadeIn delay-200">
    <!-- Total Courses -->
    <div class="gradient-card hover-lift" style="background: var(--gradient-blue-purple)">
      <div class="gradient-card-body">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-white/80">Cursos Totales</p>
            <p class="text-2xl font-bold text-white">{{ mis_ventas|length }}</p>
            <p class="text-xs text-white/90 mt-1">
              <span class="inline-flex items-center">
                <svg class="w-2.5 h-2.5 mr-1" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M5.293 9.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L11 7.414V15a1 1 0 11-2 0V7.414L6.707 9.707a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                </svg>
                +2 este mes
              </span>
            </p>
          </div>
          <div class="w-12 h-12 bg-white/10 backdrop-blur-sm rounded-xl flex items-center justify-center">
            <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
            </svg>
          </div>
        </div>
      </div>
    </div>

    <!-- Hours Studied -->
    <div class="gradient-card hover-lift" style="background: var(--gradient-purple-pink)">
      <div class="gradient-card-body">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-white/80">Horas Estudiadas</p>
            <p class="text-2xl font-bold text-white">47</p>
            <p class="text-xs text-white/90 mt-1">
              <span class="inline-flex items-center">
                <svg class="w-2.5 h-2.5 mr-1" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                </svg>
                +3h esta semana
              </span>
            </p>
          </div>
          <div class="w-12 h-12 bg-white/10 backdrop-blur-sm rounded-xl flex items-center justify-center">
            <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
          </div>
        </div>
      </div>
    </div>

    <!-- Certificates -->
    <div class="gradient-card hover-lift" style="background: var(--gradient-orange-amber)">
      <div class="gradient-card-body">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-white/80">Certificados</p>
            <p class="text-2xl font-bold text-white">3</p>
            <p class="text-xs text-white/90 mt-1">
              <span class="inline-flex items-center">
                <svg class="w-2.5 h-2.5 mr-1" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                </svg>
                1 nuevo disponible
              </span>
            </p>
          </div>
          <div class="w-12 h-12 bg-white/10 backdrop-blur-sm rounded-xl flex items-center justify-center">
            <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"></path>
            </svg>
          </div>
        </div>
      </div>
    </div>

    <!-- Current Streak -->
    <div class="gradient-card hover-lift" style="background: var(--gradient-emerald-teal)">
      <div class="gradient-card-body">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-white/80">Racha Actual</p>
            <p class="text-2xl font-bold text-white">12 dÃ­as</p>
            <p class="text-xs text-white/90 mt-1">
              <span class="inline-flex items-center">
                <svg class="w-2.5 h-2.5 mr-1" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03zM12.12 15.12A3 3 0 017 13s.879.5 2.5.5c0-1 .5-4 1.25-4.5.5 1 .786 1.293 1.371 1.879A2.99 2.99 0 0113 13a2.99 2.99 0 01-.879 2.121z" clip-rule="evenodd"></path>
                </svg>
                Â¡Sigue asÃ­!
              </span>
            </p>
          </div>
          <div class="w-12 h-12 bg-white/10 backdrop-blur-sm rounded-xl flex items-center justify-center">
            <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7C14 5 16.09 5.777 17.656 7.343A7.975 7.975 0 0120 13a7.975 7.975 0 01-2.343 5.657z"></path>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.879 16.121A3 3 0 1012.015 11L11 14H9c0 .768.293 1.536.879 2.121z"></path>
            </svg>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Course Sections -->
  <div class="space-y-8">
    <!-- Continue Learning con Degradados -->
    {% if current_user.is_authenticated %}
    <section class="animate-fadeInUp delay-300">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-bold" style="color: var(--text-primary)">ContinÃºa Aprendiendo</h2>
        <a href="#" class="btn-gradient btn-sm">
          Ver todos
        </a>
      </div>
      
      <div class="course-grid">
        {% for venta in mis_ventas %}
          {% if venta.estado_transferencia == 'confirmada' and venta.fecha_expiracion > current_time %}
          <div class="gradient-card hover-lift card-animated course-item"
               data-name="{{ venta.curso.nombre.lower() }}">
            <div class="course-thumbnail h-48 rounded-t-xl flex items-center justify-center relative">
              <div class="absolute inset-0 bg-gradient-to-br from-primary-500 to-secondary-500 opacity-90"></div>
              <div class="relative z-10 text-center text-white">
                <svg class="w-10 h-10 mx-auto mb-3 opacity-80" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h1m4 0h1m-6 4h8m-10 5h12a3 3 0 003-3V7a3 3 0 00-3-3H5a3 3 0 00-3 3v9a3 3 0 003 3z"></path>
                </svg>
                <p class="font-medium">{{ venta.curso.nombre[:20] }}...</p>
              </div>
              
              <!-- Progress Ring con Degradado -->
              <div class="absolute top-4 right-4">
                <svg class="progress-ring w-16 h-16">
                  <circle class="progress-ring__circle" />
                  <circle class="progress-ring__progress" 
                          style="stroke-dashoffset: {{ 188.4 - (188.4 * 65 / 100) }}; stroke: var(--color-white);" />
                </svg>
                <div class="absolute inset-0 flex items-center justify-center">
                  <span class="text-white text-xs font-bold">65%</span>
                </div>
              </div>
            </div>
            
            <div class="card-body" style="background: var(--bg-primary);">
              <div class="flex items-start justify-between mb-3">
                <h3 class="font-semibold line-clamp-2" style="color: var(--text-primary);">
                  {{ venta.curso.nombre }}
                </h3>
                <span class="badge-gradient success text-xs">Activo</span>
              </div>
              
              <div class="space-y-2 text-sm mb-4" style="color: var(--text-secondary);">
                <div class="flex items-center gap-2">
                  <svg class="w-3 h-3" style="color: var(--color-primary);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                  <span>Comprado: {{ venta.fecha_venta.strftime('%d/%m/%Y') }}</span>
                </div>
                <div class="flex items-center gap-2">
                  <svg class="w-3 h-3" style="color: var(--color-primary);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3a4 4 0 118 0v4M5 10h14a1 1 0 011 1v10a1 1 0 01-1 1H5a1 1 0 01-1-1V11a1 1 0 011-1z"></path>
                  </svg>
                  <span>Expira: {{ venta.fecha_expiracion.strftime('%d/%m/%Y') }}</span>
                </div>
              </div>
              
              <!-- Progress Bar con Degradado -->
              <div class="mb-4">
                <div class="flex justify-between text-xs mb-1" style="color: var(--text-secondary);">
                  <span>Progreso</span>
                  <span style="color: var(--color-primary);" class="font-bold">65%</span>
                </div>
                <div class="progress-bar h-2">
                  <div class="progress-fill" style="width: 65%; background: var(--gradient-blue-purple);"></div>
                </div>
              </div>
              
              <div class="flex gap-2">
                <a href="{{ url_for('ver_curso', curso_id=venta.curso.id) }}" 
                   class="btn-gradient flex-1 btn-sm">
                  <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h1m4 0h1m-6 4h8m-10 5h12a3 3 0 003-3V7a3 3 0 00-3-3H5a3 3 0 00-3 3v9a3 3 0 003 3z"></path>
                  </svg>
                  Continuar
                </a>
                <button class="btn-ghost-gradient btn-sm px-3">
                  <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                  </svg>
                </button>
              </div>
            </div>
          </div>
          {% endif %}
        {% endfor %}
      </div>
    </section>
    {% endif %}

    <!-- All Courses -->
    <section class="animate-fadeInUp delay-400">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-bold" style="color: var(--text-primary)">Todos los Cursos</h2>
        <div class="flex items-center gap-3">
          <select class="input-standard" id="sort-select" style="min-width: 200px;">
            <option value="name">Ordenar por nombre</option>
            <option value="price">Ordenar por precio</option>
            <option value="date">MÃ¡s recientes</option>
          </select>
        </div>
      </div>
      
      <div class="course-grid">
        {% for curso in cursos %}
        <div class="gradient-card hover-lift card-animated course-item"
             data-name="{{ curso.nombre.lower() }}"
             data-price="{{ curso.precio }}">
          <div class="course-thumbnail h-48 rounded-t-xl flex items-center justify-center" style="background: var(--gradient-slate-blue);">
            <div class="text-center text-white">
              <svg class="w-10 h-10 mx-auto mb-3 opacity-80" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
              </svg>
              <p class="font-medium">{{ curso.nombre[:20] }}...</p>
            </div>
          </div>
          
          <div class="card-body" style="background: var(--bg-primary); color: var(--text-primary);">
            <h3 class="font-semibold mb-2 line-clamp-2" style="color: var(--text-primary);">
              {{ curso.nombre }}
            </h3>
            
            <p class="text-sm mb-4 line-clamp-3" style="color: var(--text-secondary);">
              {{ curso.descripcion or 'DescripciÃ³n del curso no disponible.' }}
            </p>
            
            <div class="flex items-center justify-between">
              <span class="text-2xl font-bold" style="color: var(--color-primary);">
                ${{ curso.precio }}
              </span>
              
              {% set user_purchased = False %}
              {% for venta in mis_ventas %}
                {% if venta.curso.id == curso.id and venta.estado_transferencia == 'confirmada' %}
                  {% set user_purchased = True %}
                {% endif %}
              {% endfor %}
              
              {% if user_purchased %}
                <a href="{{ url_for('ver_curso', curso_id=curso.id) }}" 
                   class="btn-gradient success btn-sm">
                  <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                  </svg>
                  Acceder
                </a>
              {% else %}
                <a href="{{ url_for('comprar_curso', curso_id=curso.id) }}" 
                   class="btn-gradient btn-sm">
                  <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4m.6 8L4 6H2m3 7v6a1 1 0 001 1h10a1 1 0 001-1v-6M5 13h14"></path>
                  </svg>
                  Comprar
                </a>
              {% endif %}
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </section>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Search functionality
    const searchInput = document.getElementById('search-input');
    const courseItems = document.querySelectorAll('.course-item');
    
    if (searchInput) {
      searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        
        courseItems.forEach(item => {
          const courseName = item.getAttribute('data-name') || '';
          if (courseName.includes(searchTerm)) {
            item.style.display = 'block';
          } else {
            item.style.display = 'none';
          }
        });
      });
    }
    
    // Sort functionality
    const sortSelect = document.getElementById('sort-select');
    if (sortSelect) {
      sortSelect.addEventListener('change', function() {
        const courseGrid = document.querySelector('.course-grid');
        const courses = Array.from(courseGrid.children);
        
        courses.sort((a, b) => {
          if (this.value === 'name') {
            const nameA = a.getAttribute('data-name') || '';
            const nameB = b.getAttribute('data-name') || '';
            return nameA.localeCompare(nameB);
          } else if (this.value === 'price') {
            const priceA = parseFloat(a.getAttribute('data-price')) || 0;
            const priceB = parseFloat(b.getAttribute('data-price')) || 0;
            return priceA - priceB;
          }
          return 0;
        });
        
        courses.forEach(course => courseGrid.appendChild(course));
      });
    }
  });
</script>
{% endblock %}